


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A site for knowledge sharing and neat things.">
      
      
        <link rel="canonical" href="http://copperlight.github.io/ansible/ansible-vault-and-ssh-key-distribution/">
      
      
        <meta name="author" content="Matthew Johnson">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.3">
    
    
      
        <title>Ansible Vault and SSH Key Distribution - Copperlight Writes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6e35a1a6.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52382416-1","copperlight.github.io"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ansible-vault-and-ssh-key-distribution" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://copperlight.github.io/" title="Copperlight Writes" class="md-header-nav__button md-logo" aria-label="Copperlight Writes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Copperlight Writes
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Ansible Vault and SSH Key Distribution
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/copperlight/copperlight.github.io" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://copperlight.github.io/" title="Copperlight Writes" class="md-nav__button md-logo" aria-label="Copperlight Writes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Copperlight Writes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/copperlight/copperlight.github.io" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Ansible
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Ansible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Ansible
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="Ansible Vault and SSH Key Distribution" class="md-nav__link md-nav__link--active">
      Ansible Vault and SSH Key Distribution
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../running-ansible-playbooks-on-windows/" title="Running Ansible Playbooks on Windows" class="md-nav__link">
      Running Ansible Playbooks on Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../testing-ansible-galaxy-roles-with-docker/" title="Testing Ansible Galaxy Roles with Docker" class="md-nav__link">
      Testing Ansible Galaxy Roles with Docker
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      AWS
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="AWS" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        AWS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/assume-role-with-awscli/" title="Assume Role with AWSCLI" class="md-nav__link">
      Assume Role with AWSCLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/aws-credential-files-for-java-and-python/" title="AWS Credential Files for Java and Python" class="md-nav__link">
      AWS Credential Files for Java and Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/build-a-fake-instance-metadata-server-for-ubuntu-on-vagrant/" title="Build a Fake Instance Metadata Server for Ubuntu on Vagrant" class="md-nav__link">
      Build a Fake Instance Metadata Server for Ubuntu on Vagrant
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/checking-and-changing-content-type-of-s3-object-with-awscli/" title="Checking and Changing Content-Type of S3 Object with AWSCLI" class="md-nav__link">
      Checking and Changing Content-Type of S3 Object with AWSCLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/configuring-multiple-interfaces-on-the-same-network-in-ec2/" title="Configuring Multiple Interfaces on the Same Network in EC2" class="md-nav__link">
      Configuring Multiple Interfaces on the Same Network in EC2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      GitHub
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="GitHub" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        GitHub
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../github/how-i-built-my-site/" title="How I Built My Site" class="md-nav__link">
      How I Built My Site
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Linux
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Linux" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/apache-deflate-and-cors-headers/" title="Apache Deflate and CORS Headers" class="md-nav__link">
      Apache Deflate and CORS Headers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/linux-ftrace-delivers-dtrace-like-functionality/" title="Linux ftrace Delivers dtrace-like Functionality" class="md-nav__link">
      Linux ftrace Delivers dtrace-like Functionality
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Misc
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Misc" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/clone-stash-pull-requests/" title="Clone Stash Pull Requests" class="md-nav__link">
      Clone Stash Pull Requests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/dual-boot-osx-10.10-and-ubuntu-14.04-on-a-2013-macbook-pro-retina/" title="Dual Boot OSX 10.10 and Ubuntu 14.04 on a 2013 Macbook Pro Retina" class="md-nav__link">
      Dual Boot OSX 10.10 and Ubuntu 14.04 on a 2013 Macbook Pro Retina
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/reset-jenkins-build-number/" title="Reset Jenkins Build Number" class="md-nav__link">
      Reset Jenkins Build Number
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/switching-jdks-in-osx/" title="Switching JDKs in OSX" class="md-nav__link">
      Switching JDKs in OSX
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Python
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Python" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/accessing-google-apis-with-python/" title="Accessing Google APIs with Python" class="md-nav__link">
      Accessing Google APIs with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/building-rest-apis-with-python-flask/" title="Building REST APIs with Python Flask" class="md-nav__link">
      Building REST APIs with Python Flask
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/install-the-latest-python-versions-on-macosx/" title="Install the Latest Python Versions on Mac OSX" class="md-nav__link">
      Install the Latest Python Versions on Mac OSX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/memory-profiling-with-pyrasite-and-heapy/" title="Memory Profiling with Pyrasite and Heapy" class="md-nav__link">
      Memory Profiling with Pyrasite and Heapy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/stop-using-print-for-debugging/" title="Stop Using "print" for Debugging" class="md-nav__link">
      Stop Using "print" for Debugging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Recipes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Recipes" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Recipes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../recipes/galaxys-best-margarita/" title="Galaxy's Best Margarita" class="md-nav__link">
      Galaxy's Best Margarita
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Running
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Running" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Running
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../running/garmin-935-navigation/" title="Garmin 935 Navigation" class="md-nav__link">
      Garmin 935 Navigation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Scala
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Scala" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Scala
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/intellij-configuration-tips/" title="IntelliJ Configuration Tips" class="md-nav__link">
      IntelliJ Configuration Tips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/jmh-testing-with-scala/" title="JMH Testing with Scala" class="md-nav__link">
      JMH Testing with Scala
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/overview-of-debugging-tools/" title="Overview of Debugging Tools" class="md-nav__link">
      Overview of Debugging Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/scalafmt-configuration-tips/" title="Scalafmt Configuration Tips" class="md-nav__link">
      Scalafmt Configuration Tips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/starting-scala-repls-with-gradle-and-sbt/" title="Starting Scala REPLs with Gradle and SBT" class="md-nav__link">
      Starting Scala REPLs with Gradle and SBT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/testing-aws-clients-with-iam-assumerole-credentials-in-scala/" title="Testing AWS Clients with IAM AssumeRole Credentials in Scala" class="md-nav__link">
      Testing AWS Clients with IAM AssumeRole Credentials in Scala
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/using-gradle-to-run-scala-projects-locally/" title="Using Gradle to Run Scala Projects Locally" class="md-nav__link">
      Using Gradle to Run Scala Projects Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scala/using-the-scala-repl-to-configure-amazon-ses-notifications/" title="Using the Scala REPL to Configure Amazon SES Notifications" class="md-nav__link">
      Using the Scala REPL to Configure Amazon SES Notifications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Shell
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Shell" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Shell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../shell/measuring-transfer-speed-over-time-with-curl/" title="Measuring Transfer Speed Over Time with cURL" class="md-nav__link">
      Measuring Transfer Speed Over Time with cURL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../shell/parsing-json-on-the-command-line/" title="Parsing JSON on the Command Line" class="md-nav__link">
      Parsing JSON on the Command Line
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../shell/pet-cli-snippet-manager/" title="pet - CLI Snippet Manager" class="md-nav__link">
      pet - CLI Snippet Manager
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../shell/schedule-ad-hoc-jobs-for-later-on-an-instance-with-atd/" title="Schedule Ad-Hoc Jobs for Later on an Instance with atd" class="md-nav__link">
      Schedule Ad-Hoc Jobs for Later on an Instance with atd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../shell/zsh-keyboard-shortcuts/" title="Z Shell Keyboard Shortcuts" class="md-nav__link">
      Z Shell Keyboard Shortcuts
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Stocks
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Stocks" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Stocks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../stocks/nflx-quarterly-subscriber-growth/" title="Netflix Quarterly Growth" class="md-nav__link">
      Netflix Quarterly Growth
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Talks
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Talks" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Talks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../talks/favorite/" title="Favorite" class="md-nav__link">
      Favorite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../talks/netflix-atlas-telemetry-a-platform-begets-an-ecosystem/" title="Netflix Atlas Telemetry - A Platform Begets an Ecosystem" class="md-nav__link">
      Netflix Atlas Telemetry - A Platform Begets an Ecosystem
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="ansible-vault-and-ssh-key-distribution">Ansible Vault and SSH Key Distribution<a class="headerlink" href="#ansible-vault-and-ssh-key-distribution" title="Permanent link">&para;</a></h1>
<div class="meta">
  <span class="date"><small>2014-06-30</small></span>
  <span class="discuss"><a class="github-button" href="https://github.com/copperlight/copperlight.github.io/issues" data-icon="octicon-issue-opened" aria-label="Discuss copperlight/copperlight.github.io on GitHub">Discuss</a></span>
</div>

<p><br/></p>
<p>There are two types of SSH key distribution discussed in this post: private keys on local hosts and
public keys on remote hosts.  SSH private key distribution is best used for setting up your own
workstation or possibly an <a href="http://www.ansible.com/tower">Ansible Tower</a> server.  In general, you
should not be distributing private keys widely; with a good SSH tunneling configuration and SSH
public key distribution, there should be no need for the private keys to be installed in more than
few places.  This configuration will show off a technique for configuring an SSH jump host bastion
that allows you to keep your private key on your own workstation; there is no need to have the SSH
private key on the bastion host.</p>
<p>For the purpose of this post, I have generated a new SSH key pair to demonstrate this technique;
this keypair is used nowhere.  Part of the trick to making this work is that the private key needs
to be base64 encoded so that line breaks are preserved when it is stored as a yaml string in the
<code>vars_files</code>.  Template files are created for the public and private keys to preserve file change
detection.</p>
<p>Generate a new key pair:</p>
<div class="highlight"><pre><span></span><code>$ ssh-keygen -b <span class="m">2048</span> -f junk_key -C junk
Generating public/private rsa key pair.
Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:
Enter same passphrase again:
Your identification has been saved in junk_key.
Your public key has been saved in junk_key.pub.
The key fingerprint is:
<span class="m">94</span>:94:ae:ac:c3:5e:ee:7d:fa:2c:cb:0f:ae:19:c8:99 junk
The key<span class="err">&#39;</span>s randomart image is:
+--<span class="o">[</span> RSA <span class="m">2048</span><span class="o">]</span>----+
<span class="p">|</span>        ..       <span class="p">|</span>
<span class="p">|</span>       ...       <span class="p">|</span>
<span class="p">|</span>       .o        <span class="p">|</span>
<span class="p">|</span>       ..        <span class="p">|</span>
<span class="p">|</span>     . .S        <span class="p">|</span>
<span class="p">|</span>   . +o          <span class="p">|</span>
<span class="p">|</span>   .E.o .        <span class="p">|</span>
<span class="p">|</span>    +o *.o.      <span class="p">|</span>
<span class="p">|</span>   ..o<span class="o">=</span>.*B+      <span class="p">|</span>
+-----------------+
&lt;/pre&gt;
</code></pre></div>

<p>Base64 encode the private key:</p>
<div class="highlight"><pre><span></span><code>base64 -i junk_key &gt; junk_key.b64
</code></pre></div>

<p>Create an Ansible vars_files yaml data file named <code>ssh_keys/ssh_key_vault.yml</code>.  The
<code>ssh_private_key</code> variable should contain the base64 encoded private key and the <code>ssh_public_key</code>
variable should contain the public key. Encrypt the file with <code>ansible-vault</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">ssh_private_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBeUtIRlhKWFJweXlCV2FobGExM2I5S2t1aGlwSHNkVkR4dDhaZnJrMWpqd1NnNEhCCmEzMzBnQnBxUFk1SkVxeEtPV0F3WWZleExwZ3VFcHk0Z2o5S1JxZGxTb0lsYllWbEtaUnY4RmhRSC9iT3lIKzAKVytJb0VzZ096MjR6U1ZQRU9ybWV6d3QzMzN0OWh0NDFsWVBBTHpzbkVaem9vVWE4ZTVKc1RzT0YzQzdmaUh3NApBSXZTOStWVUp5Mm8wUnZQN2ZMQkttV0FBN2dvWVA3d1Z6aVNQbEVrVVJIRGEyNXBVTmRTU1lxQzI2Y0c0UWNPCk14Q3VOeXdFRks0TGl5Q21zcHNXSnkzV3BkQ1FYQ0k1Q0J0SUVVTnR6Y1FpTFQvd0ZwbzRpRnp4NEREbkRsZWcKdkc2L1JHelFqMVJyeWRFdCtTNVdHenMzYkJHbDgxOWMvSmpPNVFJREFRQUJBb0lCQUYyQXZ5a3lEWDVheUlIUApjRXpFZG5Fa3M3RUZYVnBzcU9Tekx2K1hNM1Z4VzdOOE1uZDFRUkMrdnNxbldEamlvTWp5b2puV0pQWXhLQysyCmFHc1RNZnVSb2l4Q1VVMGtnUXdLeU14N2JBUXBreDl3SE05QnJDbHNvVEpkQ252ZkZUSEZObFVKNURqOEpYbEkKY0RLWkwyVVRyVmFSQ1AyNHFManllWldQbkFBTDZPc1JwSUc1Ukp1ays2QTVmVEppL0FVTmp4a2FIM1VOUklmTwpMZjYwOVJIUHZKUEtPNkNnNWVzK3RSY0VlbnR6ZVJxeENkYkh1b2NESjluUWNRQjVIVVBaeVdYOGwzODhJQ1hhCm5oaCt6VUhlYWY4cEM1dE9STGh0aDdsR1FFN3NOQ1FQRkovMHVCVWhleEVWREwxcU1Vd2JRZUpFU2orUmMrMi8KazRZeFhEVUNnWUVBNjhaNzRGUlJuUmViZy8xT2Z2K3ZlY0p2akEyRi9oWTBDVkpBOHdTcHdpNTlHTUpUS3g1TQpFWCtwNHBhMlY3NDZTZFFjY2l4K3hlWlhyZXkvbXhLWlByZnE0bVl1ZkJRRmVPT2tuWWdXTEhXUjV2cW1zUkFwCmZMQlhTbGdZNzV6SGFzSWJmOVlQZDhZQytLV1J4RlZyQml4eEtPQ2o1WFlrZmhoZkFnaDJsNnNDZ1lFQTJkZU4KM3FvR1lDM09GdllmWTJKVTQ4a2RvejNuT09uN09rd1pHNTFZOW5GM3JTYWpUeW9XRHpLTzc5MUNtK0hGNmhFWgpBWFlzeDlTcXJER1JYT2lvUi9ZMEpNVDZsS0ZuTUJpWERmRWROUVFCYStQQ3RFNWhqdTFoS1dPOHlIN21pZk1DCnQ0OHZBbGk5NEQxZjNxa2FjREtmRWVpa2VaazZaWWFhUWFTZ1k2OENnWUVBb0cxb3dzWjgxZWhIVURNZW96bDAKKytONkpSRGFtSDRoSUNxUXVRcjJPNE9JYVQxb2U5RmNyeGR2MEJiK3NZdGxlL0RRL2pzYWM2djlBd0l4aWVISQoxaTBzcktvY2ZSN2VibGh2SFNXSStPMXl2bmpVeld3UzNwM2FkMktrYlAzL2pydlBIRmZhSklSZVp6TzVrSjhTCmVKdnF6NGF5M3FKWnlGYnE1cVk5azRzQ2dZQmlzNVhtTTJkY0lLVG1KbkltVjZGYTYvN3Z2ZGFNSlFmZGJDbGMKSjdqdFFKQVc5aEM4aDdjaS82ZGY2d0tKR296UDl4czdYRTRCNU12SDVWV1ZvUnpPTGpHR0QzSHg4Z2VNOVRkTAo2OWx0OGZpcTU3R0tmSkViYjFhOHFDSWJQZFE2NE01MFdQM1Z0RnVqeEdzeHViRHU4U0M5dm9qM1I0UDhDRGJRClUwVVFwUUtCZ1FDc0pyMlBrdFl0QWJteHdCbUMrT1FVOFd4dHQwZ2ZoNGluZHpVV2J3MFZWY3Ivb3A5aDliekoKWG9TSVVSenQwUjZmNVVDK1RwQUdxY3ZPKzhtTUgwbnZpZ2VuYkhXdk01WFBuSUtwR2RLZmc4QkxUMUZnR2t3Ugpma2tydnpwWjM1dWpCTkRWdnl4ZWVCTyt2MTVqc0N1YTFTS0FsaXpzaWJrdE9lM1F1VTkwS3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span>

<span class="nt">ssh_public_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIocVcldGnLIFZqGVrXdv0qS6GKkex1UPG3xl+uTWOPBKDgcFrffSAGmo9jkkSrEo5YDBh97EumC4SnLiCP0pGp2VKgiVthWUplG/wWFAf9s7If7Rb4igSyA7PbjNJU8Q6uZ7PC3ffe32G3jWVg8AvOycRnOihRrx7kmxOw4XcLt+IfDgAi9L35VQnLajRG8/t8sEqZYADuChg/vBXOJI+USRREcNrbmlQ11JJioLbpwbhBw4zEK43LAQUrguLIKaymxYnLdal0JBcIjkIG0gRQ23NxCItP/AWmjiIXPHgMOcOV6C8br9EbNCPVGvJ0S35LlYbOzdsEaXzX1z8mM7l junk</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>ansible-vault encrypt ssh_keys/ssh_key_vault.yml
Vault password:
Confirm Vault password:
Encryption successful
</code></pre></div>

<p>Create an inventory file named <code>inventory</code>, showing off the SSH jump host connection capability:</p>
<div class="highlight"><pre><span></span><code><span class="k">[localhost]</span>
<span class="na">localhost ansible_connection</span><span class="o">=</span><span class="s">local</span>

<span class="k">[group-all:children]</span>
<span class="na">group-01</span>
<span class="na">group-02</span>

<span class="k">[group-01]</span>
<span class="na">i-00000001 ansible_ssh_host</span><span class="o">=</span><span class="s">bastion+192.168.1.1 ansible_ssh_user=remoteuser</span>
<span class="na">i-00000002 ansible_ssh_host</span><span class="o">=</span><span class="s">bastion+192.168.1.2 ansible_ssh_user=remoteuser</span>

<span class="k">[group-02]</span>
<span class="na">i-00000003 ansible_ssh_host</span><span class="o">=</span><span class="s">bastion+192.168.1.3 ansible_ssh_user=remoteuser</span>
<span class="na">i-00000004 ansible_ssh_host</span><span class="o">=</span><span class="s">bastion+192.168.1.4 ansible_ssh_user=remoteuser</span>
</code></pre></div>

<p>Create a template file for the private key named <code>templates/HOME_.ssh_junk</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">{{</span><span class="nv">ssh_private_key_decoded.stdout</span><span class="cp">}}</span><span class="x"></span>
</code></pre></div>

<p>Create a template file for the public key named <code>templates/HOME_.ssh_junk.pub</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">{{</span><span class="nv">ssh_public_key</span><span class="cp">}}</span><span class="x"></span>
</code></pre></div>

<p>Create a template file for the SSH jump host configuration named <code>templates/HOME_.ssh_config</code>:</p>
<div class="highlight"><pre><span></span><code><span class="x">Host *</span>
<span class="x">    ServerAliveInterval 30</span>
<span class="x">    ServerAliveCountMax 5</span>

<span class="x">Host bastion</span>
<span class="x">    User </span><span class="cp">{{</span><span class="nv">remote_user</span><span class="cp">}}</span><span class="x"></span>
<span class="x">    IdentityFile ~/.ssh/junk</span>
<span class="x">    Hostname bastion</span>

<span class="x">Host bastion+*</span>
<span class="x">    User </span><span class="cp">{{</span><span class="nv">remote_user</span><span class="cp">}}</span><span class="x"></span>
<span class="x">    IdentityFile ~/.ssh/junk</span>
<span class="x">    ProxyCommand ssh -T -a bastion nc $(echo %h |cut -d+ -f2) %p 2&gt;/dev/null</span>
<span class="x">    StrictHostKeyChecking no</span>
</code></pre></div>

<p>This configuration assumes that you have a consistent remote username defined on the bastion server
and your protected hosts.</p>
<p>Write a playbook to install the SSH key and configuration on your local workstation named
<code>config_local-ssh.yml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">configure local ssh</span>
  <span class="nt">hosts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="nt">gather_facts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="nt">sudo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="nt">vars</span><span class="p">:</span>
    <span class="nt">local_home</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,&#39;HOME&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">local_user</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,&#39;USER&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">remote_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remoteuser</span>
  <span class="nt">vars_files</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ssh_keys/ssh_key_vault.yml</span>
  <span class="nt">tasks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">path={{local_home}}/.ssh state=directory mode=0700 owner={{local_user}}</span>

  <span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=templates/HOME_.ssh_config dest={{local_home}}/.ssh/config mode=0644 owner={{local_user}} backup=yes</span>

  <span class="p p-Indicator">-</span> <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo {{ssh_private_key}} |base64 --decode</span>
    <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh_private_key_decoded</span>

  <span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=templates/HOME_.ssh_junk dest={{local_home}}/.ssh/junk mode=0600 owner={{local_user}}</span>

  <span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=templates/HOME_.ssh_junk.pub dest={{local_home}}/.ssh/junk.pub mode=0644 owner={{local_user}}</span>
</code></pre></div>

<p>Run the playbook to setup your local workstation with SSH keys and configuration:</p>
<div class="highlight"><pre><span></span><code>ansible-playbook -i inventory config_local-ssh.yml --ask-vault-pass
Vault password:
</code></pre></div>

<p>Test your SSH tunneling access to a remote host behind the bastion server:</p>
<div class="highlight"><pre><span></span><code>ssh bastion+192.168.1.1
ssh bastion+192.168.1.1 <span class="s2">&quot;date; date &gt; /tmp/date.out&quot;</span>
scp bastion+192.168.1.1:/tmp/date.out .
</code></pre></div>

<p>Notice that the hosts behind the bastion server are referenced in the SSH command the same way that
they are referenced in the Ansible inventory file.  The "+" character used as a separator was
selected explicitly for its ability to be used interchangeably at the command line and in the
Ansible inventory.  IP addresses are being used on the right hand side of the expression since the
secondary connection to the protected host relies on the name resolution capabilities of the first
host in the tunnel.  If you had a reliable dynamic DNS service that was keeping up with changes to
the protected hosts and was accessible to the bastion host, then you could use host names instead,
such as <code>bastion+webserver01</code>.  This host selection technique can be extended to an Ansible dynamic
inventory script, if you were running instances at a cloud provider such as AWS.  When you write a
<a href="http://docs.ansible.com/developing_inventory.html">dynamic inventory script</a>, the data format
should look like this:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;group-01&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;i-00000001&quot;</span><span class="p">,</span>
            <span class="s2">&quot;i-00000002&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;group-02&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;i-00000003&quot;</span><span class="p">,</span>
            <span class="s2">&quot;i-00000004&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;group-all&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;children&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;group-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;group-02&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;localhost&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;localhost&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;hostvars&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;i-00000001&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;bastion+192.168.1.1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ansible_ssh_user&quot;</span><span class="p">:</span> <span class="s2">&quot;remoteuser&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;i-00000002&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;bastion+192.168.1.2&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ansible_ssh_user&quot;</span><span class="p">:</span> <span class="s2">&quot;remoteuser&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;i-00000003&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;bastion+192.168.1.3&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ansible_ssh_user&quot;</span><span class="p">:</span> <span class="s2">&quot;remoteuser&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;i-00000004&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;bastion+192.168.1.4&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ansible_ssh_user&quot;</span><span class="p">:</span> <span class="s2">&quot;remoteuser&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;localhost&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_connection&quot;</span><span class="p">:</span> <span class="s2">&quot;local&quot;</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The nice thing about this style of SSH configuration is that you can have multiple bastion hosts in
different locations and target the hosts behind each of them, provided that you give your bastion
hosts different names.  The method of accessing them is the same between direct SSH connections and
Ansible execution.  Once you have this infrastructure in place, you can start distributing public
SSH keys to your protected hosts.</p>
<p>Write a <code>templates/etc_sudoers</code> file that grants NOPASSWD access to the sudo group:</p>
<div class="highlight"><pre><span></span><code>Defaults    env_reset
Defaults    mail_badpass
Defaults    secure_path=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
root    ALL=(ALL:ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=NOPASSWD: ALL

#includedir /etc/sudoers.d
</code></pre></div>

<p>Write a playbook <code>update_remote-ssh.yml</code> to configure NOPASSWD sudo access for your remote user and
distribute SSH public keys on your remote hosts.  This will allow subsequent playbook execution to
operate more easily against your remote hosts.  In order for this to work, the paramiko connection
type must be used initially, so that the password can be requested once and re-used across all hosts.</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">update remote ssh</span>
  <span class="nt">hosts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">group-all</span>
  <span class="nt">gather_facts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="nt">sudo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">paramiko</span>
  <span class="nt">vars_files</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ssh_keys/ssh_key_vault.yml</span>
  <span class="nt">tasks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">copy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=templates/etc_sudoers dest=/etc/sudoers mode=0440 owner=root group=root</span>

  <span class="p p-Indicator">-</span> <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=remoteuser groups=sudo shell=/bin/bash state=present</span>

  <span class="p p-Indicator">-</span> <span class="nt">authorized_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user=remoteuser state=present key={{ssh_public_key}}</span>
</code></pre></div>

<p>Run an SSH configuration playbook against remote hosts through the SSH tunnel, providing the SSH
password, sudo password and vault password:</p>
<div class="highlight"><pre><span></span><code>ansible-playbook -i inventory update_remote-ssh.yml --ask-pass --ask-sudo-pass --ask-vault-pass
SSH password:
sudo password <span class="o">[</span>defaults to SSH password<span class="o">]</span>:
Vault password:

PLAY <span class="o">[</span>update ssh<span class="o">]</span> *************************************************************

TASK: <span class="o">[</span>copy <span class="nv">src</span><span class="o">=</span>templates/etc_sudoers <span class="nv">dest</span><span class="o">=</span>/etc/sudoers <span class="nv">mode</span><span class="o">=</span><span class="m">0440</span> <span class="nv">owner</span><span class="o">=</span>root <span class="nv">group</span><span class="o">=</span>root<span class="o">]</span> ***
ok: <span class="o">[</span>i-00000001<span class="o">]</span>
ok: <span class="o">[</span>i-00000002<span class="o">]</span>
ok: <span class="o">[</span>i-00000003<span class="o">]</span>
ok: <span class="o">[</span>i-00000004<span class="o">]</span>

TASK: <span class="o">[</span>user <span class="nv">name</span><span class="o">=</span>remoteuser <span class="nv">groups</span><span class="o">=</span>sudo <span class="nv">shell</span><span class="o">=</span>/bin/bash <span class="nv">state</span><span class="o">=</span>present<span class="o">]</span> ***
ok: <span class="o">[</span>i-00000001<span class="o">]</span>
ok: <span class="o">[</span>i-00000002<span class="o">]</span>
ok: <span class="o">[</span>i-00000003<span class="o">]</span>
ok: <span class="o">[</span>i-00000004<span class="o">]</span>

TASK: <span class="o">[</span>authorized_key <span class="nv">user</span><span class="o">=</span>remoteuser <span class="nv">state</span><span class="o">=</span>present <span class="nv">key</span><span class="o">=</span><span class="s2">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIocVcldGnLIFZqGVrXdv0qS6GKkex1UPG3xl+uTWOPBKDgcFrffSAGmo9jkkSrEo5YDBh97EumC4SnLiCP0pGp2VKgiVthWUplG/wWFAf9s7If7Rb4igSyA7PbjNJU8Q6uZ7PC3ffe32G3jWVg8AvOycRnOihRrx7kmxOw4XcLt+IfDgAi9L35VQnLajRG8/t8sEqZYADuChg/vBXOJI+USRREcNrbmlQ11JJioLbpwbhBw4zEK43LAQUrguLIKaymxYnLdal0JBcIjkIG0gRQ23NxCItP/AWmjiIXPHgMOcOV6C8br9EbNCPVGvJ0S35LlYbOzdsEaXzX1z8mM7l junk&quot;</span><span class="o">]</span> ***
ok: <span class="o">[</span>i-00000001<span class="o">]</span>
ok: <span class="o">[</span>i-00000002<span class="o">]</span>
ok: <span class="o">[</span>i-00000003<span class="o">]</span>
ok: <span class="o">[</span>i-00000004<span class="o">]</span>


PLAY RECAP ********************************************************************
i-00000001               : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
i-00000002               : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
i-00000003               : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
i-00000004               : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>

<p>The best way to keep Ansible output concise is to run without verbosity -- only crank this up if you
need it to diagnose a problem.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../.." title="Home" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </div>
            </div>
          </a>
        
        
          <a href="../running-ansible-playbooks-on-windows/" title="Running Ansible Playbooks on Windows" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Running Ansible Playbooks on Windows
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.a45f732b.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.c03f0417.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://buttons.github.io/buttons.js"></script>
      
    
  </body>
</html>